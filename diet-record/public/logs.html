<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é£²é£Ÿç´€éŒ„</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">ğŸ“ é£²é£Ÿç´€éŒ„è¡¨å–®</h2>

    <form id="logForm" class="mb-5">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">æ—¥æœŸ</label>
          <input type="date" class="form-control" id="log_date" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">æ™‚é–“ï¼æ™‚æ®µ</label>
          <input type="text" class="form-control" id="log_time" placeholder="æ—©é¤ã€åˆé¤ã€08:00â€¦">
        </div>
        <div class="col-md-6">
          <label class="form-label">æè¿°</label>
          <input type="text" class="form-control" id="description">
        </div>

        <div class="col-md-2">
          <label class="form-label">å…¨ç©€é›œç³§</label>
          <input type="number" step="0.1" min="0" class="form-control" id="grains" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">è±†é­šè›‹è‚‰</label>
          <input type="number" step="0.1" min="0" class="form-control" id="protein" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">è”¬èœ</label>
          <input type="number" step="0.1" min="0" class="form-control" id="vegetables" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">æ°´æœ</label>
          <input type="number" step="0.1" min="0" class="form-control" id="fruits" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">ä¹³å“</label>
          <input type="number" step="0.1" min="0" class="form-control" id="dairy" value="0">
        </div>
        <div class="col-md-2">
          <label class="form-label">æ²¹è„‚ï¼å …æœ</label>
          <input type="number" step="0.1" min="0" class="form-control" id="fats" value="0">
        </div>
        <input type="hidden" id="source" value="æ‰‹å‹•è¼¸å…¥">

        <div class="col-12">
          <button type="submit" class="btn btn-primary">é€å‡ºç´€éŒ„</button>
          <a href="report.html" class="btn btn-outline-secondary float-end">ğŸ“Š æŸ¥çœ‹åˆ†æ</a>
        </div>
      </div>
    </form>

    <h3 class="mt-5 mb-3">ğŸ“‹ æ­·å²ç´€éŒ„</h3>
    <div id="logsList" class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>æè¿°</th><th>å…­å¤§é¡</th><th>ç†±é‡</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="logsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('token')
    if (!token) location.href = '/static/login.html'

    const form = document.getElementById('logForm')
    const body = document.getElementById('logsBody')

    // æäº¤è¡¨å–®
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const payload = {
        log_date: document.getElementById('log_date').value,
        log_time: document.getElementById('log_time').value,
        description: document.getElementById('description').value,
        grains: parseFloat(document.getElementById('grains').value || '0'),
        protein: parseFloat(document.getElementById('protein').value || '0'),
        vegetables: parseFloat(document.getElementById('vegetables').value || '0'),
        fruits: parseFloat(document.getElementById('fruits').value || '0'),
        dairy: parseFloat(document.getElementById('dairy').value || '0'),
        fats: parseFloat(document.getElementById('fats').value || '0'),
        source: 'æ‰‹å‹•è¼¸å…¥',
      }

      const res = await fetch('/api/logs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      })

      if (res.ok) {
        form.reset()
        document.getElementById('log_date').value = new Date().toISOString().slice(0, 10)
        loadLogs()
      } else {
        alert('ç´€éŒ„å¤±æ•—')
      }
    })

    // è¼‰å…¥ç´€éŒ„åˆ—è¡¨
    async function loadLogs() {
      const res = await fetch('/api/logs', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()

      body.innerHTML = ''
      data.forEach(log => {
        const row = `
          <tr data-id="${log.id}">
            <td>${log.log_date}</td>
            <td>${log.log_time || ''}</td>
            <td>${log.description || ''}</td>
            <td>
              ç©€${log.grains}ã€è›‹${log.protein}ã€èœ${log.vegetables}<br>
              æœ${log.fruits}ã€ä¹³${log.dairy}ã€è„‚${log.fats}
            </td>
            <td>${Math.round(log.calories)} kcal</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary btn-edit">ç·¨è¼¯</button>
              <button class="btn btn-sm btn-outline-danger btn-delete">åˆªé™¤</button>
            </td>
          </tr>
        `
        body.insertAdjacentHTML('beforeend', row)
      })
    }

    // åˆå§‹åŒ–
    document.getElementById('log_date').value = new Date().toISOString().slice(0, 10)
    loadLogs()
    body.addEventListener('click', async (e) => {
      const row = e.target.closest('tr')
      const id = row?.dataset.id
      if (!id) return

      if (e.target.classList.contains('btn-delete')) {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
          const res = await fetch(`/api/logs/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          })
          if (res.ok) {
            row.remove()
          } else {
            alert('åˆªé™¤å¤±æ•—')
          }
        }
      }

      if (e.target.classList.contains('btn-edit')) {
        const cells = row.querySelectorAll('td')
        document.getElementById('log_date').value = cells[0].textContent
        document.getElementById('log_time').value = cells[1].textContent
        document.getElementById('description').value = cells[2].textContent

        // å…­å¤§é¡è§£æ
        const match = cells[3].textContent.match(/ç©€(\d+\.?\d*)ã€è›‹(\d+\.?\d*)ã€èœ(\d+\.?\d*)æœ(\d+\.?\d*)ã€ä¹³(\d+\.?\d*)ã€è„‚(\d+\.?\d*)/)
        if (match) {
          document.getElementById('grains').value = match[1]
          document.getElementById('protein').value = match[2]
          document.getElementById('vegetables').value = match[3]
          document.getElementById('fruits').value = match[4]
          document.getElementById('dairy').value = match[5]
          document.getElementById('fats').value = match[6]
        }

        // å„²å­˜ç·¨è¼¯å¾Œæ”¹ç‚º PUT è«‹æ±‚
        form.onsubmit = async (evt) => {
          evt.preventDefault()
          const payload = {
            log_date: document.getElementById('log_date').value,
            log_time: document.getElementById('log_time').value,
            description: document.getElementById('description').value,
            grains: parseFloat(document.getElementById('grains').value || '0'),
            protein: parseFloat(document.getElementById('protein').value || '0'),
            vegetables: parseFloat(document.getElementById('vegetables').value || '0'),
            fruits: parseFloat(document.getElementById('fruits').value || '0'),
            dairy: parseFloat(document.getElementById('dairy').value || '0'),
            fats: parseFloat(document.getElementById('fats').value || '0'),
            source: 'æ‰‹å‹•ç·¨è¼¯',
          }

          const res = await fetch(`/api/logs/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          })

          if (res.ok) {
            form.reset()
            form.onsubmit = defaultSubmitHandler // æ¢å¾©åŸæœ¬è¡Œç‚º
            document.getElementById('log_date').value = new Date().toISOString().slice(0, 10)
            loadLogs()
          } else {
            alert('æ›´æ–°å¤±æ•—')
          }
        }
      }
    })

    // é è¨­é€å‡ºè™•ç†
    const defaultSubmitHandler = form.onsubmit
  </script>
</body>
</html>
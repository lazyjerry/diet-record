<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é£²é£Ÿçµ±è¨ˆ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2>ğŸ“Š é£²é£Ÿçµ±è¨ˆåœ–è¡¨</h2>
    <div class="mb-3">
      <select id="rangeSelector" class="form-select w-auto d-inline-block">
        <option value="7days">è¿‘ä¸ƒæ—¥</option>
        <option value="month">æœ¬æœˆ</option>
      </select>
      <a href="logs.html" class="btn btn-outline-primary float-end">ğŸ”™ å›ç´€éŒ„é </a>
    </div>
    <canvas id="chart" height="150"></canvas>
  </div>

  <script>
    const token = localStorage.getItem('token')
    if (!token) location.href = '/login.html'

    const ctx = document.getElementById('chart').getContext('2d')
    let chart

    async function loadStats(range = '7days') {
      const res = await fetch(`/api/stats?range=${range}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()

      const labels = data.map(d => d.log_date)
      const calories = data.map(d => d.calories)
      const carbs = data.map(d => d.carbs)
      const proteins = data.map(d => d.proteins)
      const fats = data.map(d => d.fats_total)

      if (chart) chart.destroy()

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'ç†±é‡ (kcal)', data: calories, borderWidth: 2 },
            { label: 'ç¢³æ°´ (g)', data: carbs, borderWidth: 2 },
            { label: 'è›‹ç™½è³ª (g)', data: proteins, borderWidth: 2 },
            { label: 'è„‚è‚ª (g)', data: fats, borderWidth: 2 },
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      })
    }

    document.getElementById('rangeSelector').addEventListener('change', (e) => {
      loadStats(e.target.value)
    })

    loadStats()
  </script>
</body>
</html>